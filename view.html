<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Document Viewer â€” The PDF Files</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .view-wrap { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .view-header { 
      background: var(--surface,#1a1410); border-radius: 0.75rem; padding: 1.5rem;
      margin-bottom: 1.5rem; border: 1px solid rgba(212,175,55,0.2);
    }
    .view-efta { font: 700 1.8rem var(--mono,monospace); color: #d4af37; margin: 0 0 0.5rem; }
    .view-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 0.75rem 0; }
    .view-chip {
      font: 600 0.72rem var(--mono,monospace); padding: 0.2rem 0.6rem;
      border-radius: 0.35rem; display: inline-block;
    }
    .chip-folder { background: #2d1f0e; color: #d4af37; border: 1px solid #5e4732; }
    .chip-ds { background: #1a2a1a; color: #6dbf6d; border: 1px solid #3a5a3a; }
    .chip-tags { background: #1a1a2a; color: #8f9fbf; border: 1px solid #3a3a5a; }
    .chip-words { background: #2a1a1a; color: #bf8f8f; border: 1px solid #5a3a3a; }
    .view-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
    .view-actions a, .view-actions button {
      font: 600 0.8rem var(--mono,monospace); padding: 0.4rem 0.8rem;
      border-radius: 0.4rem; text-decoration: none; cursor: pointer; border: none;
    }
    .btn-doj { background: #8f2f15; color: #fff; }
    .btn-doj:hover { background: #a83a1a; }
    .btn-search { background: #d4af37; color: #000; }
    .btn-search:hover { background: #e0c050; }
    .btn-copy { background: #333; color: #ccc; border: 1px solid #555 !important; }
    .btn-copy:hover { background: #444; }
    .view-pages { display: flex; flex-direction: column; gap: 1rem; }
    .page-card {
      background: var(--surface,#1a1410); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 0.6rem; padding: 1.2rem; 
    }
    .page-card-head { 
      font: 600 0.75rem var(--mono,monospace); color: #999; margin-bottom: 0.5rem;
      display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;
    }
    .page-text {
      font: 400 0.85rem/1.6 var(--mono,monospace); color: #d0c8b8;
      white-space: pre-wrap; word-break: break-word;
      background: #0d0b08; border-radius: 0.4rem; padding: 1rem;
      max-height: 600px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.05);
    }
    .view-loading { text-align: center; color: #888; padding: 3rem 0; font-size: 1.1rem; }
    .view-error { text-align: center; color: #c44; padding: 2rem 0; }
    .view-note {
      background: rgba(212,175,55,0.08); border: 1px solid rgba(212,175,55,0.2);
      border-radius: 0.5rem; padding: 1rem; margin-top: 0.5rem;
      font-size: 0.8rem; color: #b0a080; line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="noise"></div>
  <script src="./nav.js"></script>

  <div class="view-wrap">
    <div id="viewContent">
      <div class="view-loading">Loading document...</div>
    </div>
  </div>

  <script>
  (function() {
    "use strict";
    var TXT_BASE = "https://eyeswidewoke.github.io/PDF-Files-text/data/txt/";
    var DOJ_RECORDS = "https://www.justice.gov/usao-sdny/jeffrey-epstein-records";

    var params = new URLSearchParams(location.search);
    var efta = (params.get("id") || "").toUpperCase().trim();
    var query = params.get("q") || "";

    var container = document.getElementById("viewContent");

    if (!efta || !efta.startsWith("EFTA")) {
      container.innerHTML = '<div class="view-error">No valid EFTA ID provided. Use ?id=EFTA00657267</div>';
      return;
    }

    document.title = efta + " â€” The PDF Files";
    var digits = efta.replace(/^EFTA/, "");
    var prefix = digits.substring(0, 4);
    var shardUrl = TXT_BASE + prefix + ".json";
    // DOJ has removed individual PDF links; link to records page instead

    // Show header immediately
    container.innerHTML =
      '<div class="view-header">' +
        '<h1 class="view-efta">' + efta + '</h1>' +
        '<div class="view-actions">' +
          '<a class="btn-doj" href="' + DOJ_RECORDS + '" target="_blank" rel="noopener">DOJ Records Page â†’</a>' +
          '<a class="btn-search" href="./ftx-search.html?q=' + encodeURIComponent(efta) + '">Search in Full-Text Index â†’</a>' +
          '<button class="btn-copy" onclick="navigator.clipboard.writeText(\'' + efta + '\');this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy EFTA ID\',1500)">ðŸ“‹ Copy EFTA ID</button>' +
        '</div>' +
        '<div class="view-note">' +
          'This shows the OCR-extracted text from the original PDF. ' +
          'Text may contain OCR artifacts. To find the original PDF, copy the EFTA ID and search on the DOJ records page.' +
        '</div>' +
      '</div>' +
      '<div id="viewPages"><div class="view-loading">Loading text from shard ' + prefix + '...</div></div>';

    fetch(shardUrl)
      .then(function(res) {
        if (!res.ok) throw new Error("Text shard not found (HTTP " + res.status + ")");
        return res.json();
      })
      .then(function(shard) {
        var pages = shard[efta];
        var pagesEl = document.getElementById("viewPages");
        if (!pages || pages.length === 0) {
          pagesEl.innerHTML = '<div class="view-error">No extracted text found for ' + efta + '.<br>Try <a href="' + DOJ_RECORDS + '" target="_blank" style="color:#d4af37">searching the DOJ records page</a>.</div>';
          return;
        }

        // Update header with metadata
        var meta = pages[0];
        var totalWords = pages.reduce(function(s, p) { return s + (p.w || 0); }, 0);
        
        var html = '';
        for (var i = 0; i < pages.length; i++) {
          var p = pages[i];
          var text = p.x || "(no text extracted)";
          var truncated = p.tr ? ' <span style="color:#d4af37">[preview â€” text truncated]</span>' : '';
          html +=
            '<div class="page-card">' +
              '<div class="page-card-head">' +
                '<span>Page ' + (i + 1) + ' of ' + pages.length + '</span>' +
                '<span>' + (p.f || '') + '</span>' +
                '<span>' + (p.t || '').replace(/\\+/g, ', ') + '</span>' +
                '<span>' + (p.w || 0) + ' words' + truncated + '</span>' +
              '</div>' +
              '<div class="page-text">' + escHtml(text) + '</div>' +
            '</div>';
        }
        pagesEl.innerHTML = html;
      })
      .catch(function(err) {
        document.getElementById("viewPages").innerHTML =
          '<div class="view-error">' +
            'Could not load text: ' + err.message + '<br><br>' +
            'You can try <a href="' + DOJ_RECORDS + '" target="_blank" style="color:#d4af37">searching the DOJ records page</a> using the EFTA ID.' +
          '</div>';
      });

    function escHtml(s) {
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }
  })();
  </script>
</body>
</html>